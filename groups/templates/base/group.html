{% extends 'base/main.html' %}

{% block content %}
    <h1>{{ name }}</h1>
    <p>{{ message }}</p>
    <h2>Songs:</h2>
    <ul>
        {% for song in songs %}
            <li>
                {{ song.song.title }}
                {{ song.song.artist }}
                <img src="{{ song.img_url }}" alt="Album Artwork" height="100" width="100">
                <a href="{% url 'song-detail' song.song.id %}">View Song</a>
                <button data-song-id="{{ song.song.id }}" class="remove-song-group">Remove Song</button>
            </li>
        {% empty %}
            <li>No songs in this group.</li>
        {% endfor %}
    </ul>

    <h2>Users:</h2>
    <ul>
        {% for user in users %}
            <li>{{ user.username }}</li>
            {% if is_current_user_admin %}
                {% if not user.admin %}
                    <button class="make-admin" data-user-id="{{ user.user_id }}">Make Admin</button>
                    <button class="remove-item" data-item-title="{{ user.username }}" data-item-location="{{ name }}" data-group-id="{{ group_id }}" data-user-id="{{ user.user_id }}">
                        Remove User
                    </button>
                {% endif %}
            {% endif %}
        {% empty %}
            <li>No users in this group.</li>
        {% endfor %}
    </ul>

    {% if is_current_user_admin %}
        <button id="add-user-button">Add User</button>
        <button id="edit-message-button">Edit Group Message</button>
        <button id="edit-group-name-button">Edit Group Name</button>
    {% endif %} 
    <button>Leave Group</button>
    {% if is_current_user_admin %}
        <button>Delete Group</button>
    {% endif %}

    <form id="add-user-form" style="display: none;" action="{% url 'add-user' group_id %}" method="post">
        {% csrf_token %}
        {{ form }}
        <label for="username-input">Username:</label>
        <input type="text" name="username"></input>
        <label for="make-admin-input">Make Admin?</label>
        <input type="checkbox" id="make-admin-input" name="make_admin_form"></input>
        <input type="submit" value="Submit"></input>
    </form>
        
    <form id="edit-message-form" style="display: none;" action="{% url 'edit-message' group_id %}" method="post">
        {% csrf_token %}
        {{ form }}
        <label for="message-input">Message:</label>
        <textarea name="message"></textarea>
        <input type="submit" value="Submit"></input>
    </form>

    <form id="edit-group-name-form" style="display: none;" action="{% url 'edit-group-name' group_id %}" method="post">
        {% csrf_token %}
        {{ form }}
        <label for="group-name-input">Group Name:</label>
        <input type="text" name="group_name"></input>
        <input type="submit" value="Submit"></input>
    </form>

    {% load static %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
        var csrftoken = "{{ csrf_token }}";
        var groupId = "{{ group_id }}";

        $('#add-user-form').on('submit', function(event) {
            event.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr('action'),
                method: form.attr('method'),
                data: form.serialize(),
                success: function(data) {
                    location.reload();
                },
                error: function(xhr) {
                    alert(JSON.parse(xhr.responseText).message);        
                }
            });
        });

        $('#add-user-button').on('click', function() {
            $('#add-user-form').show();
        });

        window.onload = function () {
            handleItemRemoval(csrftoken, 'your library');
        };

        document.addEventListener('DOMContentLoaded', function() {
            var makeAdminButton = document.querySelector('.make-admin');
            if (makeAdminButton) {
            makeAdminButton.addEventListener('click', function() {
                var userId = makeAdminButton.dataset.userId
                    fetch('/make-admin/' + groupId + '/' + userId + '/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({})
                    }).then(function(response) {
                        return response.json()
                    }).then(function(data) {
                        alert(data.message)
                        location.reload()
                    })
                })
            }
        });

        
        document.addEventListener('DOMContentLoaded', function() {
            var editMessageButton = document.querySelector('#edit-message-button');
            var editMessageForm = document.querySelector('#edit-message-form');

            // Show the form when the button is clicked
            editMessageButton.addEventListener('click', function(event) {
                editMessageForm.style.display = 'block';
            });

            // Submit the form data when the form is submitted
            editMessageForm.addEventListener('submit', function(event) {
                event.preventDefault();  // Prevent the form from being submitted normally

                var message = editMessageForm.querySelector('textarea[name="message"]').value;

                fetch('/edit-message/' + groupId + '/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        message: message
                    })
                }).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    location.reload();
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            var removeSongGroupButton = document.querySelector('.remove-song-group');
            if (removeSongGroupButton) {
            removeSongGroupButton.addEventListener('click', function() {
                var songId = removeSongGroupButton.dataset.songId
                    fetch('/remove-song-group/' + groupId + '/' + songId + '/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({})
                    }).then(function(response) {
                        return response.json()
                    }).then(function(data) {
                        location.reload()
                    })
                })
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            var editGroupNameButton = document.querySelector('#edit-group-name-button');
            var editGroupNameForm = document.querySelector('#edit-group-name-form');

            // Show the form when the button is clicked
            editGroupNameButton.addEventListener('click', function(event) {
                editGroupNameForm.style.display = 'block';
            });

            // Submit the form data when the form is submitted
            editGroupNameForm.addEventListener('submit', function(event) {
                event.preventDefault();  // Prevent the form from being submitted normally

                var groupName = editGroupNameForm.querySelector('input[name="group_name"]').value;

                fetch('/edit-group-name/' + groupId + '/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        group_name: groupName
                    })
                }).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    location.reload();
                });
            });
        });
    </script>
{% endblock %}
